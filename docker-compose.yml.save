services:
  roscore:
    image: ros:noetic-ros-core
    container_name: roscore
    command: roscore
    network_mode: host
    restart: unless-stopped
    environment:
      - ROS_MASTER_URI=http://127.0.0.1:11311
      - ROS_IP=127.0.0.1
   # volumes:
     # - ./media/group7/USB-ESD:/storage

  camera:
    build:
      context: .
      dockerfile: camera_ws/Dockerfile
    container_name: camera
    image: arm64v8/ros:noetic-ros-base
    command: >
      bash -c "sleep 3 &&
      source /opt/ros/noetic/setup.bash &&
      roslaunch usb_cam camera.launch"
    devices:
      - "/dev/video0:/dev/video0" # IMPORTANT: Make sure this device is correct
    depends_on:
      - roscore
    network_mode: host
    restart: unless-stopped
    environment:
      - ROS_MASTER_URI=http://127.0.0.1:11311
      - ROS_IP=127.0.0.1
    volumes:
      - ./camera_ws/launch:/opt/ros/noetic/share/usb_cam/launch

  camera_stereo:
    build:
      context: .
      dockerfile: camera_stereo_ws/Dockerfile # Points to the new Dockerfile
    container_name: camera_stereo
    network_mode: host
    privileged: true
    restart: unless-stopped
    # Use the correct package name and launch file
    command: bash -c "sleep 3 && roslaunch /etc/ros/stereo_bringup.launch"
    depends_on:
      - roscore
    environment:
      - ROS_MASTER_URI=http://127.0.0.1:11311
      - ROS_IP=127.0.0.1
    # Mount your local config directory into the container
    volumes:
      - ./camera_stereo_ws/config:/root/calib
    # Add device access for cameras
    devices:
      - "/dev/video0:/dev/video0"
      - "/dev/video1:/dev/video1"

  camera_mono:
    build:
      context: ./camera_mono_ws
      dockerfile: Dockerfile # Points to the new Dockerfile
    container_name: camera_mono
    network_mode: host
    privileged: true
    restart: unless-stopped
    # Use the correct package name and launch file
    command: bash -c "sleep 3 && roslaunch /etc/ros/camera_bringup.launch"
    depends_on:
      - roscore
    restart: unless-stopped
    environment:
      - ROS_MASTER_URI=http://127.0.0.1:11311
      - ROS_IP=127.0.0.1
    # Mount your local config directory into the container
    volumes:
      - ./camera_mono_ws/config:/root/calib
    # Add device access for cameras
    devices:
      - "/dev/video0:/dev/video0"

  imu_node:
    build: ./imu_ws
    container_name: imu_node
    restart: unless-stopped
    privileged: true
    depends_on:
      - roscore
    network_mode: host
    #command: bash -c "sleep 3 && roslaunch /launches/icm20948.launch"
    restart: unless-stopped
    environment:
      - ROS_MASTER_URI=http://127.0.0.1:11311
      - ROS_IP=127.0.0.1
    devices:
      - "/dev/i2c-1:/dev/i2c-1"
    group_add:
      - "i2c"
    volumes:
      - ./imu_ws/ros_icm20948/launches:/opt/ros/noetic/share/imu/launch

#  mavros:
#    build:
#      context: ./mavros_ws
#      dockerfile: Dockerfile
#    container_name: mavros
#    depends_on:
#      - roscore
#    network_mode: host
#    volumes:
#      - /home/group7/ros_bags:/root/ros_bags
#    devices:
    #   - "/dev/ttyACM0:/dev/ttyACM0" #RPI Serial USB
#      - "/dev/ttyAMA10:/dev/ttyAMA10" #RPI Serial GPIO Dedicated
    # command: ["roslaunch", "mavros", "apm.launch", "fcu_url:=/dev/ttyACM0:115200"] #RPI Serial USB
#    command: ["roslaunch", "mavros", "apm.launch", "fcu_url:=/dev/ttyAMA10:921600"] #RPI Serial GPIO Dedicated
    #command: ["roslaunch", "mavros", "apm.launch", "fcu_url:=/dev/ttyAMA10:921600"]
#    environment:
#      - ROS_MASTER_URI=http://127.0.0.1:11311
#      - ROS_IP=127.0.0.1

  mavros:
    build:
      context: ./mavros_ws
      dockerfile: Dockerfile
    container_name: mavros
    depends_on:
      - roscore
    network_mode: host
    volumes:
      - /home/group7/ros_bags:/root/ros_bags
    devices:
    #   - "/dev/ttyACM0:/dev/ttyACM0" #RPI Serial USB
      - "/dev/ttyAMA10:/dev/ttyAMA10" #RPI Serial GPIO Dedicated
    # command: ["roslaunch", "mavros", "apm.launch", "fcu_url:=/dev/ttyACM0:115200"] #RPI Serial USB
    command: >
      bash -c "
      rosparam set /mavros/plugin_whitelist \"['*']\" &&
      roslaunch mavros apm.launch fcu_url:=/dev/ttyAMA10:921600
      "
    #command: ["roslaunch", "mavros", "apm.launch", "fcu_url:=/dev/ttyAMA10:921600"]
    restart: unless-stopped
    environment:
      - ROS_MASTER_URI=http://127.0.0.1:11311
      - ROS_IP=127.0.0.1

  orbslam3:
    build:
      context: ./orbslam3_ws
    container_name: orbslam3
    network_mode: host
    command: >
      bash -c "sleep 3 &&
      rosrun ORB_SLAM3 Mono
      /root/ORB_SLAM3/Vocabulary/ORBvoc.txt
      /root/catkin_ws/src/ORB_SLAM3/Examples/Monocular/TUM1.yaml"
    depends_on:
      - roscore
      - camera_mono
      - mavros
    restart: unless-stopped
    environment:
      - ROS_MASTER_URI=http://127.0.0.1:11311
      - ROS_IP=127.0.0.1
      - QT_X11_NO_MITSHM=1
    volumes:
      - ./orbslam3_ws/config:/root/orbslam3_config
      - ./orbslam3_ws/launch:/root/orbslam3_launch
      - /tmp/.X11-unix:/tmp/.X11-unix

  vinsfusion:
    build:
      context: ./vinsfusion_ws
      dockerfile: Dockerfile
    container_name: vinsfusion
    network_mode: host
    stdin_open: true
    tty: true
    command: >
      bash -c "sleep 5 &&
      source /opt/ros/noetic/setup.bash &&
      source /root/catkin_ws/devel/setup.bash &&
      exec bash"
    depends_on:
      - roscore
      - camera_mono
      - mavros
    restart: unless-stopped
    environment:
      - ROS_MASTER_URI=http://127.0.0.1:11311
      - ROS_IP=127.0.0.1
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1  # Often helps with stability in Docker
      - XAUTHORITY=/root/.Xauthority # Add this line
    volumes:
      - ./vinsfusion_ws/config:/root/catkin_ws/src/VINS-Fusion/config
      - ./vinsfusion_ws/launch:/root/vins_launch
      - ./vinsfusion_output:/root/output:rw
      - /media/group7/Lexar/ros_bags:/root/rosbags
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ~/.Xauthority:/root/.Xauthority:rw # Add this line

  imu_analyzer:
    build:
      context: ./allan_variance_ros_ws
      dockerfile: Dockerfile
    container_name: imu_analyzer
    depends_on:
      - roscore
      - mavros  # Depends on mavros to ensure the IMU topic is available
    network_mode: host
    #command: >
    #  bash -c "chmod +x /scripts/run_allan_variance.sh && 
    #  /scripts/run_allan_variance.sh"
    restart: unless-stopped
    environment:
      - ROS_MASTER_URI=http://127.0.0.1:11311
      - ROS_IP=127.0.0.1
      - IMU_TOPIC=/mavros/imu/data_raw
      - DURATION=60
    volumes:
      - ./allan_variance_ros_ws/config:/config
      - ./allan_variance_ros_ws/imu_results:/data
      - ./allan_variance_ros_ws/scripts:/scripts
  vinsfusion:
    build:
      context: ./vinsfusion_ws
      dockerfile: Dockerfile
    container_name: vinsfusion
    network_mode: host
    stdin_open: true
    tty: true
    command: >
      bash -c "sleep 5 &&
      source /opt/ros/noetic/setup.bash &&
      source /root/catkin_ws/devel/setup.bash &&
      exec bash"
    depends_on:
      - roscore
      - camera_mono
      - mavros
    environment:
      - ROS_MASTER_URI=http://127.0.0.1:11311
      - ROS_IP=127.0.0.1
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1  # Often helps with stability in Docker
      - XAUTHORITY=/root/.Xauthority # Add this line
    volumes:
      - ./vinsfusion_ws/config:/root/catkin_ws/src/VINS-Fusion/config
      - ./vinsfusion_ws/launch:/root/vins_launch
      - ./vinsfusion_output:/root/output:rw
      - /media/group7/Lexar/ros_bags:/root/rosbags
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ~/.Xauthority:/root/.Xauthority:rw # Add this line

  ros_tools:
    build:
      context: ./ros_tools_ws
      dockerfile: Dockerfile
    container_name: ros_tools
    depends_on:
      - roscore
      - mavros #for IMU Topics
      - camera_mono #for Camera Topics
    network_mode: host
    image: ros-tools # Give the built image a name
    restart: unless-stopped
    environment:
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1 # Often helps with stability for Qt apps like RQT
      - ROS_MASTER_URI=http://127.0.0.1:11311
      - ROS_IP=127.0.0.1
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ~/.Xauthority:/root/.Xauthority:rw # Add this line
      - /media/group7/Lexar/ros_bags:/root/rosbags
      - ./ros_tools_ws/scripts:/scripts
    #Keep container running for exec ---
    stdin_open: true  # Equivalent to -i
    tty: true         # Equivalent to -t
